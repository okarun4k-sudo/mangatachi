<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - MangaTachi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* MANTENDO O ESTILO PROFISSIONAL ORIGINAL */
        .profile-container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }
        
        /* Header Profile */
        .profile-header {
            display: flex; gap: 4rem; margin-bottom: 3rem; padding: 2rem;
            background: var(--background-card); border-radius: 16px;
            box-shadow: var(--card-shadow); border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative; overflow: hidden;
            animation: fadeIn 0.6s ease-out;
        }
        .profile-header::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
        }

        /* Avatar */
        .profile-avatar-container { flex-shrink: 0; position: relative; }
        .profile-avatar {
            width: 160px; height: 160px; border-radius: 50%; object-fit: cover;
            border: 4px solid var(--primary-color); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }
        .profile-avatar:hover { transform: scale(1.05); }

        /* Info Text */
        .profile-info-main { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .profile-username {
            font-size: 2rem; font-weight: 700; color: var(--text-light); margin: 0;
            background: linear-gradient(135deg, var(--text-light), var(--primary-color));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        /* Badges */
        .profile-badges { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .profile-badge {
            display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.4rem 0.8rem;
            border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
        }
        .badge-premium { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
        .badge-verified { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; }
        .badge-member { background: linear-gradient(135deg, #2196F3, #1976D2); color: white; }

        /* Stats Grid */
        .profile-stats {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1.5rem; margin-top: 1.5rem; padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05); border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-item { text-align: center; }
        .stat-number { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); display: block; }
        .stat-label { font-size: 0.85rem; color: var(--text-gray); }

        /* Sections */
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .info-section {
            background: var(--background-card); border-radius: 16px; padding: 2rem;
            box-shadow: var(--card-shadow); border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .section-title { font-size: 1.4rem; font-weight: 700; color: var(--text-light); margin-bottom: 1.5rem; border-bottom: 2px solid rgba(255, 255, 255, 0.1); padding-bottom: 0.5rem; }
        
        .info-item {
            display: flex; justify-content: space-between; padding: 1rem;
            background: rgba(255, 255, 255, 0.05); border-radius: 10px; margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
        }
        .info-value { color: var(--text-light); font-weight: 500; }

        /* Liked Mangas Grid */
        .liked-mangas-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
        .liked-manga-card {
            background: rgba(255, 255, 255, 0.05); border-radius: 12px; overflow: hidden;
            cursor: pointer; transition: transform 0.3s; border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .liked-manga-card:hover { transform: translateY(-5px); border-color: var(--primary-color); }
        .liked-manga-cover { width: 100%; height: 200px; object-fit: cover; }
        .liked-manga-title { padding: 0.5rem; font-size: 0.85rem; text-align: center; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Achievements */
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; }
        .achievement-card {
            background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 1rem;
            text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s;
        }
        .achievement-card.locked { opacity: 0.5; filter: grayscale(1); }
        .achievement-card.unlocked { border-color: var(--primary-color); background: rgba(30, 136, 229, 0.1); }
        .achievement-icon { font-size: 2rem; margin-bottom: 0.5rem; color: var(--primary-color); }
        
        /* Buttons */
        .btn-action {
            padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; border: none; cursor: pointer;
            display: flex; align-items: center; gap: 0.5rem; transition: 0.3s;
        }
        .btn-logout { background: rgba(220, 53, 69, 0.2); color: #dc3545; border: 1px solid rgba(220, 53, 69, 0.3); }
        .btn-logout:hover { background: rgba(220, 53, 69, 0.3); transform: translateY(-2px); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .profile-header { flex-direction: column; text-align: center; gap: 1.5rem; }
            .profile-avatar { margin: 0 auto; }
            .profile-badges { justify-content: center; }
            .info-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <button onclick="window.location.href='index.html'" class="btn-back">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
                <h1 class="logo"><i class="fas fa-book"></i> MangaTachi</h1>
                <div style="width: 40px;"></div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="profile-container">
                
                <div class="profile-header">
                    <div class="profile-avatar-container">
                        <img id="profileAvatar" src="https://cdn.discordapp.com/embed/avatars/0.png" alt="Avatar" class="profile-avatar">
                    </div>
                    
                    <div class="profile-info-main">
                        <div class="profile-username-section">
                            <h1 id="profileUsername" class="profile-username">Carregando...</h1>
                            <div class="profile-badges" id="profileBadges">
                                </div>
                        </div>
                        
                        <div class="profile-actions" style="margin-top: 1rem; display: flex; gap: 10px; justify-content: flex-start;">
                             <button onclick="logout()" class="btn-action btn-logout">
                                <i class="fas fa-sign-out-alt"></i> Sair
                            </button>
                        </div>
                        
                        <div class="profile-stats">
                            <div class="stat-item">
                                <span id="statLikes" class="stat-number">0</span>
                                <span class="stat-label">Curtidos</span>
                            </div>
                            <div class="stat-item">
                                <span id="statRead" class="stat-number">0</span>
                                <span class="stat-label">Lidos</span>
                            </div>
                            <div class="stat-item">
                                <span id="statDays" class="stat-number">0</span>
                                <span class="stat-label">Dias de Conta</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-section">
                        <h2 class="section-title"><i class="fas fa-user-cog"></i> Detalhes da Conta</h2>
                        <div class="info-item">
                            <span class="info-label"><i class="fas fa-id-card"></i> Discord ID</span>
                            <span id="infoId" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label"><i class="fas fa-envelope"></i> Email</span>
                            <span id="infoEmail" class="info-value">•••••••</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label"><i class="fas fa-trophy"></i> Nível</span>
                            <span id="userLevel" class="info-value">Iniciante</span>
                        </div>
                    </div>

                    <div class="info-section">
                        <h2 class="section-title"><i class="fas fa-medal"></i> Conquistas</h2>
                        <div id="achievementsContainer" class="achievements-grid">
                            </div>
                    </div>
                </div>

                <div class="liked-mangas-section info-section">
                    <h2 class="section-title"><i class="fas fa-heart"></i> Mangás Curtidos</h2>
                    <div id="likedMangasContainer" class="liked-mangas-grid">
                        <div style="grid-column: 1/-1; text-align: center; color: var(--text-gray); padding: 2rem;">
                            <i class="fas fa-spinner fa-spin"></i> Carregando curtidas...
                        </div>
                    </div>
                </div>

                <div class="version-footer" id="versionFooter" style="text-align: center; margin-top: 3rem; color: var(--text-gray); font-size: 0.9rem;">
                    </div>

            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <script src="mangas_data.js"></script> 
    <script src="script.js"></script>

    <script>
        // Definição local de conquistas (Sincronizada com a lógica visual)
        const ACHIEVEMENTS = [
            { id: 'login', name: "Bem-vindo", desc: "Fazer login pela primeira vez", icon: "fa-user", condition: () => true },
            { id: 'reader_1', name: "Leitor Curioso", desc: "Ler 1 mangá", icon: "fa-book-open", condition: (stats) => stats.readCount >= 1 },
            { id: 'liker_5', name: "Fã de Mangá", desc: "Curtir 5 mangás", icon: "fa-heart", condition: (stats) => stats.likesCount >= 5 },
            { id: 'veteran', name: "Veterano", desc: "Conta com mais de 30 dias", icon: "fa-crown", condition: (stats) => stats.daysSince > 30 },
            { id: 'super_liker', name: "Colecionador", desc: "Curtir 20 mangás", icon: "fa-star", condition: (stats) => stats.likesCount >= 20 }
        ];

        document.addEventListener('DOMContentLoaded', async function() {
            // 1. Verificar Autenticação usando localStorage (padrão do script.js)
            const userDataStr = localStorage.getItem('discordUser');
            if (!userDataStr) {
                window.location.href = 'index.html';
                return;
            }
            const user = JSON.parse(userDataStr);

            // 2. Preencher Header
            document.getElementById('profileUsername').textContent = user.username;
            document.getElementById('profileAvatar').src = user.avatar 
                ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=256` 
                : 'https://cdn.discordapp.com/embed/avatars/0.png';
            
            // Info Detalhada
            document.getElementById('infoId').textContent = user.id;
            document.getElementById('infoEmail').textContent = user.email || 'Oculto';
            
            // Versão
            if (typeof SITE_VERSION !== 'undefined') {
                document.getElementById('versionFooter').textContent = `MangaTachi v${SITE_VERSION}`;
            }

            // 3. Calcular Dias de Conta
            const joinDate = new Date(user.created_at || Date.now()); // Fallback se created_at não existir
            const now = new Date();
            const diffTime = Math.abs(now - joinDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            document.getElementById('statDays').textContent = diffDays;

            // 4. Carregar Curtidas do Firebase
            // Nota: script.js inicializa 'firebaseAppLikes'. Vamos usá-lo.
            let userLikesCount = 0;
            let likedMangasIds = [];

            try {
                // Se firebaseAppLikes não estiver disponível globalmente ainda, tenta acessar via firebase.app
                const app = firebaseAppLikes || firebase.app('likes'); 
                const db = firebase.database(app);
                
                // Estrutura do firebase no script.js é: likes -> mangaId -> userId -> { data }
                // Precisamos iterar todos os mangás para achar os likes deste usuário
                // (Nota: Idealmente o firebase teria um nó users -> likes, mas vamos seguir a estrutura do script.js)
                const likesRef = db.ref('likes');
                const snapshot = await likesRef.once('value');

                if (snapshot.exists()) {
                    snapshot.forEach((mangaSnap) => {
                        if (mangaSnap.hasChild(user.id)) {
                            userLikesCount++;
                            likedMangasIds.push(mangaSnap.key); // Guarda o ID do mangá
                        }
                    });
                }
            } catch (error) {
                console.error("Erro ao carregar likes:", error);
            }

            // Atualiza UI de Likes
            document.getElementById('statLikes').textContent = userLikesCount;
            renderLikedMangas(likedMangasIds);

            // 5. Histórico de Leitura (Mock ou LocalStorage)
            // Assumindo que o script.js possa salvar em 'readingHistory' ou similar
            const history = JSON.parse(localStorage.getItem('manga_history') || '[]');
            const readCount = history.length;
            document.getElementById('statRead').textContent = readCount;

            // 6. Calcular Nível
            let level = "Iniciante";
            if (userLikesCount > 5) level = "Intermediário";
            if (userLikesCount > 20) level = "Expert";
            if (diffDays > 365) level = "Mestre";
            document.getElementById('userLevel').textContent = level;

            // 7. Renderizar Badges
            const badgesContainer = document.getElementById('profileBadges');
            let badgesHTML = '<span class="profile-badge badge-member"><i class="fas fa-user"></i> Membro</span>';
            
            if (user.verified) badgesHTML += '<span class="profile-badge badge-verified"><i class="fas fa-check"></i> Verificado</span>';
            if (diffDays > 100) badgesHTML += '<span class="profile-badge badge-premium"><i class="fas fa-crown"></i> Veterano</span>';
            
            badgesContainer.innerHTML = badgesHTML;

            // 8. Renderizar Conquistas
            const stats = { likesCount: userLikesCount, readCount: readCount, daysSince: diffDays };
            const achievementsContainer = document.getElementById('achievementsContainer');
            
            achievementsContainer.innerHTML = ACHIEVEMENTS.map(achiv => {
                const isUnlocked = achiv.condition(stats);
                return `
                    <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}">
                        <div class="achievement-icon"><i class="fas ${achiv.icon}"></i></div>
                        <div style="font-weight:bold; font-size:0.8rem; color:var(--text-light)">${achiv.name}</div>
                        <div style="font-size:0.7rem; color:var(--text-gray)">${achiv.desc}</div>
                    </div>
                `;
            }).join('');
        });

        // Função para Renderizar Grid de Mangás Curtidos
        function renderLikedMangas(ids) {
            const container = document.getElementById('likedMangasContainer');
            
            if (ids.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: var(--text-gray); padding: 2rem;">
                        <i class="far fa-heart" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Você ainda não curtiu nenhum mangá.</p>
                    </div>`;
                return;
            }

            // Precisamos da variável global 'mangas' (normalmente em mangas_data.js ou script.js)
            // Se ela não existir, mostramos um erro amigável ou tentamos buscar do script.js se exposto
            const mangasData = (typeof mangas !== 'undefined') ? mangas : [];

            const html = ids.map(id => {
                // Tenta achar o mangá pelo ID (convertendo para string/int para garantir)
                const manga = mangasData.find(m => m.id == id);
                
                if (manga) {
                    return `
                        <div class="liked-manga-card" onclick="window.location.href='index.html#/obras/${generateSlug(manga.title)}'">
                            <img src="${manga.coverUrl}" class="liked-manga-cover" loading="lazy">
                            <div class="liked-manga-title">${manga.title}</div>
                        </div>
                    `;
                }
                return ''; // Mangá não encontrado nos dados locais
            }).join('');

            container.innerHTML = html || '<p style="padding:1rem">Mangás indisponíveis no momento.</p>';
        }

        // Helper para gerar slug (igual ao do script.js)
        function generateSlug(text) {
            return text.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/(^-|-$)+/g, '');
        }

        function logout() {
            localStorage.removeItem('discordUser');
            localStorage.removeItem('discordToken');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
